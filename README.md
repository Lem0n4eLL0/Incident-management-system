# Инструкция по настройке и запуску проекта (backend)

## Стек технологий для серверной части

- **Django**
- **PostgreSQL** 
- **Python**
- **Django REST Framework**
- **Pipenv**
- **JSON Web Tokens (JWT)** 
- **Git**

## 1. Установите "Python Django", включая оболочку "Django shell".   
Чтобы проверить корректность установки, выполните в терминале команду:

```bash
pip show django
```

Здесь будет показана подробная информация о продукте, включая его версию.    
(Сервер был написан на версии Django 5.1.6)

## 2. Установите систему управления базами данных (СУБД) "PostgreSQL".
Для проверки корректности установки и версии программы, выполните в терминале команду:

```bash
psql --version
```

(Сервер использует версию 17.0)

## 3. Создайте новую базу данных.
По умолчанию сервер обращается к базе данных `incident_db`. Желательно не менять название, чтобы избежать несостыковок с моделями сервера и базы данных.

### Для этого:
1. Выполните команду:
```bash
psql -U ваш_логин -d название_БД_по_умолчанию
```

2. Введите скрытый пароль.  
3. Введите команду:
```bash
CREATE DATABASE incident_db;
```

(Должно отобразиться сообщение `CREATE DATABASE`, значит база данных успешно создана.)

## 4. Обновите файл `.env`.
Внутри папки проекта найдите файл `.env`, замените значения переменных `POSTGRES_USER` и `POSTGRES_PASSWORD` на ваши собственные данные для СУБД.

## 5. Перейдите в папку с проектом.
В новом окне терминала выполните команду для перехода в папку с проектом:

```bash
cd "путь_к_папке"
```

(Желательно путь поместить в кавычки, если он содержит пробельные символы.)

## 6. Выполните миграции базы данных.
Выполните команды:

```bash
python manage.py makemigrations
```
```bash
python manage.py migrate
```
Эти миграции создадут/изменят необходимые таблицы, модели и связи в базе данных.    
(При возникновении ошибок установите необходимые библиотеки через команду `pip install название_библиотеки`.)

## 7. Создайте суперпользователя.
Стандартная команда `python manage.py createsuperuser` может не сработать, так как изменена модель пользователя, требующая указания значения поля `unit` (Подразделение).

### Для создания админа:
1. Перейдите в папку с проектом через терминал как указано ранее.  
2. Откройте "Django shell" командой:

```bash
python manage.py shell
```

3. Введите следующий код:

```py
     from users.models import User, Unit
     from users.managers import UserManager

     unit = Unit.objects.get_or_create(name="ваше_подразделение")[0]

     user = User.all_objects.create_superuser(
     email='ваша_почта',
     password='ваш_пароль',
     login='ваш_логин',
     full_name='ваше_имя',
     unit=unit,
     position='ваша_должность',
     telephone='ваш_номер_телефона'
     )

     print("Суперпользователь создан:", user)
```

4. Вставьте код в терминал и нажмите `Enter`.  
5. Должно высветиться сообщение: `Суперпользователь создан`.  
6. Введите `exit()`, чтобы выйти из "shell".


## 8. Запустите сервер.
Перейдите в папку с проектом из терминала и выполните команду:

```bash
python manage.py runserver 8080
```

Сервер будет запущен на порту `8080`.

## 9. Запустите клиент (приложение).

---

## Внимание!

В приложении реализована система "мягкого" удаления пользователей и инцидентов. Она позволяет удалить пользователя из поля зрения клиентского приложения, но не из базы данных. Это было сделано для усиления безопасности данных.

"Мягко" удалённые данные помечаются в таблицах флажками `t (true)` или `f (false)` в поле `is_deleted`.  
Рекомендуется ознакомиться с дополнительными командами по управлению СУБД PostgreSQL для восстановления или окончательного удаления данных.

### Команды для восстановления или удаления пользователей/инцидентов:

1. Перейти в базу данных:
```bash
psql -U ваш_логин -d incident_db
```

2. Введите пароль.

3. Просмотреть список отфильтрованных полей всех записей:   

```bash
SELECT id, incident_number, description, is_deleted from incidents_incident;
SELECT id, full_name, is_deleted FROM users_user;
```

4. Выполнить команду для восстановления или окончательного удаления записи:   

```bash
UPDATE incidents_incident SET is_deleted = false WHERE id = 'id_инцидента';
DELETE FROM incidents_incident WHERE id = 'id_инцидента';

UPDATE users_user SET is_deleted = false WHERE id = 'id_пользователя';
DELETE FROM users_user WHERE id = 'id_пользователя';
```